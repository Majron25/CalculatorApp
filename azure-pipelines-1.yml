trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  azureSubscription: 'Azure subscription 1(01a2685b-2d63-4792-9b28-fbc97a9a51df)'
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

jobs:
- job: Build
  steps:
  - task: NuGetToolInstaller@1
  - task: NuGetCommand@2
    inputs:
      restoreSolution: '$(solution)'
  - task: DotNetCoreCLI@2
    inputs:
      command: 'publish'
      publishWebProjects: true
  - task: VSBuild@1
    inputs:
      solution: '$(solution)'
      msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:DesktopBuildPackageLocation="$(build.artifactStagingDirectory)\WebApp.zip" /p:DeployIisAppPath="Default Web Site"'
      platform: '$(buildPlatform)'
      configuration: '$(buildConfiguration)'
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'CalculatorAppWeb'

- job: RunUnitTests
  dependsOn: Build
  steps:
  - task: UseDotNet@2
    inputs:
      packageType: 'sdk'
      installationPath: $(Agent.ToolsDirectory)/dotnet
  - script: dotnet test UnitTestMS/UnitTestMS.csproj --configuration $(buildConfiguration)
    displayName: 'Run Unit Tests'

- job: DeployToAzure
  dependsOn: RunUnitTests
  steps:
  - task: AzureWebApp@1
    inputs:
      azureSubscription: 'Azure subscription 1(01a2685b-2d63-4792-9b28-fbc97a9a51df)'
      appType: 'webApp'
      appName: 'SDCalculatorAppWeb'
      deployToSlotOrASE: true
      resourceGroupName: 'WebAppCalculator'
      slotName: 'production'
      package: '$(System.DefaultWorkingDirectory)/CalculatorAppWeb/**/*.zip'
      deploymentMethod: 'auto'

